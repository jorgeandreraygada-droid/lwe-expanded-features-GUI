app-id: com.github.mauefrod.LWEExpandedFeaturesGUI
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: lwe-gui

# Build options to limit resource usage (compilation can be memory-intensive)
build-options:
  # Adjust if needed: jobs = (RAM_GB / 4) - 1. For 16GB: (16/4)-1 = 3 max, using 2 for safety
  env:
    MAKEFLAGS: "-j2"
    # Disable ccache to save disk space
    CCACHE_DISABLE: "1"
  # Optional: limit ninja parallel jobs as well
  cflags: "-O1"  # Use -O1 instead of -O2/-O3 to reduce compile time and memory

finish-args:
  # X11 socket for window manipulation (CRITICAL for --above flag)
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --env=DISPLAY=:0
  # Filesystem access
  - --filesystem=xdg-config/linux-wallpaper-engine-features:create
  - --filesystem=xdg-data/linux-wallpaper-engine-features:create
  - --share=network
  - --filesystem=~/.steam:ro
  - --filesystem=~/.local/share/Steam:ro
  # Additional filesystem access needed for wmctrl/xdotool to work
  - --filesystem=home:ro
  - --filesystem=/tmp
  - --env=XAUTHORITY=$HOME/.Xauthority
  # Audio
  - --socket=pulseaudio
  - --device=dri
  # DBus access for window detection and notifications
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.DBus
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Flatpak
  # System DBus for advanced window operations
  - --system-talk-name=org.freedesktop.DBus
  - --env=DBUS_FATAL_WARNINGS=0
  # Session and system bus sockets for inter-process communication
  - --socket=session-bus
  - --socket=system-bus
    # Steam Flatpak Install
  - --filesystem=~/.var/app/com.valvesoftware.Steam:ro
  # Development mode for additional capabilities (wmctrl/xdotool window manipulation)
  # This is necessary for the flags --delay, --random, --above to work properly
  - --allow=devel

modules:
  - name: bzip2
    buildsystem: simple
    build-commands:
      - make -f Makefile-libbz2_so
      - make install PREFIX=/app
      - cp -a libbz2.so* /app/lib/
    sources:
      - type: archive
        url: https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        sha256: ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269
    cleanup:
      - /share/ma
    
  - name: glu
    buildsystem: meson
    config-opts:
      - --buildtype=release
    sources:
      - type: archive
        url: https://archive.mesa3d.org/glu/glu-9.0.3.tar.xz
        sha256: bd43fe12f374b1192eb15fe20e45ff456b9bc26ab57f0eee919f96ca0f8a330f
    cleanup:
      - /include
      - /lib/pkgconfig

  - name: freeglut
    buildsystem: cmake-ninja
    config-opts:
      - -DFREEGLUT_BUILD_DEMOS=OFF
      - -DFREEGLUT_BUILD_STATIC_LIBS=OFF
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/freeglut/freeglut/3.4.0/freeglut-3.4.0.tar.gz
        sha256: 3c0bcb915d9b180a97edaebd011b7a1de54583a838644dcd42bb0ea0c6f3eaec
    cleanup:
      - /include
      - /lib/pkgconfig

  - name: glew
    buildsystem: simple
    build-commands:
      - make
      - make install GLEW_DEST=/app
    sources:
      - type: archive
        url: https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0.tgz
        sha256: d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.a'

  - name: glm
    buildsystem: simple
    build-commands:
      - cp -r glm /app/include/
    sources:
      - type: archive
        url: https://github.com/g-truc/glm/archive/refs/tags/0.9.9.8.tar.gz
        sha256: 7d508ab72cb5d43227a3711420f06ff99b0a0cb63ee2f93631b162bfe1fe9592
    cleanup:
      - '*'

   - name: glfw
     buildsystem: cmake-ninja
     config-opts:
      - -DGLFW_BUILD_EXAMPLES=OFF
      - -DGLFW_BUILD_TESTS=OFF
      - -DGLFW_BUILD_DOCS=OFF
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_INSTALL_LIBDIR=lib  # Ensure it installs to /app/lib
     post-install:
      - |
        cd /app/lib
        if [ -f libglfw.so.3 ] && [ ! -f libglfw.so ]; then
          ln -sf libglfw.so.3 libglfw.so
        fi
        if [ -f libglfw.so.3.4 ]; then
          ln -sf libglfw.so.3.4 libglfw.so.3 || true
          ln -sf libglfw.so.3.4 libglfw.so || true
        fi
     sources:
      - type: archive
        url: https://github.com/glfw/glfw/archive/refs/tags/3.4.tar.gz
        sha256: c038d34200234d071fae9345bc455e4a8f2f544ab60150765d7704e08f3dac01
     cleanup:
      - /include
      - /lib/pkgconfig

  - name: lz4
    buildsystem: simple
    build-commands:
      - make PREFIX=/app
      - make install PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/lz4/lz4/archive/refs/tags/v1.10.0.tar.gz
        sha256: 537512904744b35e232912055ccf8ec66d768639ff3abe5788d90d792ec5f48b
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - '*.a'

  - name: fribidi
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/fribidi/fribidi/releases/download/v1.0.16/fribidi-1.0.16.tar.xz
        sha256: 1b1cde5b235d40479e91be2f0e88a309e3214c8ab470ec8a2744d82a5a9ea05c
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig

  - name: libass
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.3/libass-0.17.3.tar.gz
        sha256: da7c348deb6fa6c24507afab2dee7545ba5dd5bbf90a137bfe9e738f7df68537
    cleanup:
      - /include
      - /lib/pkgconfig

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=enabled
      - -Dglslang=enabled
      - -Ddemos=false
      - -Dopengl=enabled
      - --libdir=lib  # Force installation to /app/lib instead of /app/lib64
    sources:
      - type: git
        url: https://code.videolan.org/videolan/libplacebo.git
        tag: v6.338.2
          
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=false
      - -Dlua=disabled
      - -Djavascript=disabled
      - -Dalsa=disabled
      - -Dvapoursynth=disabled
    build-commands:
      - pkg-config --exists libplacebo || (echo "libplacebo not found!" && exit 1)
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.39.0.tar.gz
        sha256: 2ca92437affb62c2b559b4419ea4785c70d023590500e8a52e95ea3ab4554683

  - name: fftw3
    buildsystem: autotools
    config-opts:
      - --enable-shared
      - --enable-threads
    sources:
      - type: archive
        url: http://www.fftw.org/fftw-3.3.10.tar.gz
        sha256: 56c932549852cddcfafdab3820b0200c7742675be92179e59e6215b340e26467
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - '*.a'

  - name: cef
    buildsystem: simple
    build-commands:
      - cp -r . /app/cef
    sources:
      - type: archive
        url: https://cef-builds.spotifycdn.com/cef_binary_135.0.17%2Bgcbc1c5b%2Bchromium-135.0.7049.52_linux64_minimal.tar.bz2
        sha256: 24ac1980e62be7b1aea2c337d6bd4bc770dccd8b37e47c6db94b397f13ec4dc6

  - name: linux-wallpaperengine
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_CXX_FLAGS=-O1
      - -DCEF_ROOT=/app/cef
      - -DCMAKE_INSTALL_PREFIX=/app
    post-install:
      - cp -v output/linux-wallpaperengine /app/bin/ || cp -v linux-wallpaperengine /app/bin/ || find . -name "linux-wallpaperengine" -type f -exec cp -v {} /app/bin/ \;
      - chmod +x /app/bin/linux-wallpaperengine
    sources:
      - type: git
        url: https://github.com/Almamu/linux-wallpaperengine.git
        branch: main
      - type: shell
        commands:
          - sed -i 's/^include(DownloadCEF)/#DISABLED# include(DownloadCEF)/' CMakeLists.txt
          - sed -i 's/^DownloadCEF(/#DISABLED# DownloadCEF(/' CMakeLists.txt
          - sed -i '/find_package(CEF REQUIRED)/a include("${CEF_ROOT}/cmake/cef_macros.cmake")' CMakeLists.txt
          - sed -i 's/^REPLACED_SET_EXECUTABLE_TARGET_PROPERTIES/#DISABLED# REPLACED_SET_EXECUTABLE_TARGET_PROPERTIES/' CMakeLists.txt
          - sed -i '/^#DISABLED# REPLACED_SET_EXECUTABLE_TARGET_PROPERTIES/a set_target_properties(linux-wallpaperengine PROPERTIES RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/output")' CMakeLists.txt
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.a'

  - name: libxmu
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXmu-1.1.4.tar.xz
        sha256: 210de3ab9c3e9382572c25d17c2518a854ce6e2c62c5f8315deac7579e758244
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: wmctrl
    buildsystem: autotools
    sources:
      - type: archive
        url: http://deb.debian.org/debian/pool/main/w/wmctrl/wmctrl_1.07.orig.tar.gz
        sha256: d78a1efdb62f18674298ad039c5cbdb1edb6e8e149bb3a8e3a01a4750aa3cca9

  - name: xdotool
    buildsystem: simple
    build-commands:
      - make
      - make PREFIX=/app install
    sources:
      - type: archive
        url: https://github.com/jordansissel/xdotool/releases/download/v3.20211022.1/xdotool-3.20211022.1.tar.gz
        sha256: 96f0facfde6d78eacad35b91b0f46fecd0b35e474c03e00e30da3fdd345f9ada

  - name: python3-pillow
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "Pillow>=9.5.0,<11" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cd/74/ad3d526f3bf7b6d3f408b73fde271ec69dfac8b81341a318ce825f2b3812/pillow-10.4.0.tar.gz
        sha256: 166c1cd4d24309b30d61f79f4a9114b7b2313d7450912277855ff5dfd7cd4a06

  - name: lwe-expanded-features-gui
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} -r requirements.txt --no-build-isolation || echo "Warning python deps failed"
      - install -d /app/share/lwe-gui
      - cp -r source /app/share/lwe-gui/
      - test -f requirements.txt && cp requirements.txt /app/share/lwe-gui/ || true
      - test -f LICENSE && cp LICENSE /app/share/lwe-gui/ || true
      - test -f README.md && cp README.md /app/share/lwe-gui/ || true
      - chmod +x /app/share/lwe-gui/source/core/main.sh || true
      - chmod +x /app/share/lwe-gui/source/core/lwe-state-manager.sh || true
      - chmod +x /app/share/lwe-gui/source/core/window-monitor.sh || true
      - chmod +x /app/share/lwe-gui/source/core/async-window-fixer.sh || true
      - test -f /app/share/lwe-gui/source/run.sh && chmod +x /app/share/lwe-gui/source/run.sh || true
      - install -Dm755 lwe-gui-wrapper.sh /app/bin/lwe-gui
      - install -Dm755 lwe-window-manager.sh /app/bin/lwe-window-manager.sh
      - install -Dm644 com.github.mauefrod.LWEExpandedFeaturesGUI.desktop /app/share/applications/com.github.mauefrod.LWEExpandedFeaturesGUI.desktop
      - install -Dm644 com.github.mauefrod.LWEExpandedFeaturesGUI.appdata.xml /app/share/metainfo/com.github.mauefrod.LWEExpandedFeaturesGUI.appdata.xml
      - test -f com.github.mauefrod.LWEExpandedFeaturesGUI.png && install -Dm644 com.github.mauefrod.LWEExpandedFeaturesGUI.png /app/share/icons/hicolor/256x256/apps/com.github.mauefrod.LWEExpandedFeaturesGUI.png || echo "No icon found, will use placeholder"
    sources:
      - type: git
        url: https://github.com/Mauefrod/lwe-expanded-features-GUI.git
        branch: main
      - type: file
        path: lwe-gui-wrapper.sh
      - type: file
        path: lwe-window-manager.sh
      - type: file
        path: com.github.mauefrod.LWEExpandedFeaturesGUI.desktop
      - type: file
        path: com.github.mauefrod.LWEExpandedFeaturesGUI.appdata.xml
      - type: file
        path: com.github.mauefrod.LWEExpandedFeaturesGUI.png
